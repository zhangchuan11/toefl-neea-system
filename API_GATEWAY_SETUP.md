# 阿里云API网关配置指南

通过API网关可以解决函数计算HTTP触发器强制下载文件的问题。

## 📋 前置条件

- ✅ 已有阿里云账号
- ✅ 函数已部署到函数计算
- ✅ （可选）已有备案的域名

## 🚀 配置步骤

### 方案A：使用API网关 + 函数计算后端（推荐）

#### 1. 登录API网关控制台

访问：https://apigateway.console.aliyun.com/

选择地域：**华东1（杭州）**（与函数计算保持一致）

#### 2. 创建API分组

1. 点击左侧菜单 **「实例管理」** → **「分组管理」**
2. 点击 **「创建分组」**
3. 填写信息：
   - **分组名称**: `toefl-neea-group`
   - **分组描述**: `托福考试报名系统`
   - **实例类型**: 选择 **「共享实例」**（免费）
4. 点击 **「确定」**

创建成功后会得到一个**二级域名**，类似：

```
http://8bb27a71343d473dabc67f1a7a5a74c1-cn-hangzhou.alicloudapi.com
http://xxxxx.cn-hangzhou.fc.aliyuncs.com
```

#### 3. 创建API

1. 进入刚创建的分组
2. 点击 **「API管理」** → **「创建API」**

##### 3.1 基础信息

- **API名称**: `toefl-all-routes`
- **安全认证**: `无认证`
- **请求协议**: `HTTP` 和 `HTTPS`

##### 3.2 定义API请求

- **请求Path**: `/*`（匹配所有路径）
- **请求Method**: `ANY`（支持所有HTTP方法）
- **请求模式**: `透传`
- **Body模型**: 不设置

##### 3.3 定义后端服务

- **后端服务类型**: 选择 **「函数计算FC」**
- **地域**: `华东1（杭州）`
- **服务名**: 选择你的函数 `toefl-neea-function`
- **函数类型**: `HTTP函数`
- **后端超时时间**: `60000`ms
- **Path**: `/*`（转发所有路径）
- **后端请求Method**: `ANY`

##### 3.4 定义返回内容

- **返回结果类型**: `透传`
- **失败返回示例**: 保持默认

#### 4. 发布API

1. 点击 **「发布」**
2. 选择环境: **「RELEASE」**（正式环境）
3. 输入版本说明: `初始版本`
4. 点击 **「发布」**

#### 5. 测试访问

发布成功后，你会得到一个API网关地址：

```
http://xxxxx.cn-hangzhou.fc.aliyuncs.com/toefl-all-routes
```

现在访问：

- **首页**: `http://你的网关地址/index.html`
- **登录页**: `http://你的网关地址/login.html`
- **API**: `http://你的网关地址/api/health`

**此时HTML应该可以正常显示，不会被下载！** ✅

---

### 方案B：绑定自定义域名（可选，需要备案域名）

如果你有已备案的域名，可以绑定到API网关：

#### 1. 添加自定义域名

1. 在API网关控制台，进入你的分组
2. 点击 **「域名管理」** → **「绑定独立域名」**
3. 填写信息：
   - **域名**: `api.yourdomain.com`（你的域名）
   - **证书**: 如果使用HTTPS需要上传SSL证书

#### 2. 配置DNS解析

在你的域名服务商处（如阿里云DNS），添加CNAME记录：

```
类型: CNAME
主机记录: api
记录值: xxxxx.cn-hangzhou.fc.aliyuncs.com (API网关提供的域名)
TTL: 600
```

#### 3. 测试自定义域名

DNS生效后（通常5-10分钟），访问：

- `http://api.yourdomain.com/index.html`

---

## 🎯 关键配置说明

### 为什么API网关能解决问题？

API网关作为代理层，可以：

1. ✅ 重写响应头，移除 `Content-Disposition: attachment`
2. ✅ 设置正确的 `Content-Type`
3. ✅ 支持自定义域名
4. ✅ 提供更多功能（流控、鉴权等）

### API网关高级配置（可选）

如果需要自定义响应头，可以在API配置中添加：

**「后端服务」** → **「常量参数」** → 添加响应头：

```
Content-Disposition: inline
```

---

## 💰 费用说明

**共享实例（免费额度）**:

- 前100万次调用：免费
- 流量：前1GB免费
- 超出后按量付费，费用很低

**专享实例**（高性能场景）:

- 从 ¥650/月起
- 通常不需要

---

## 🔍 故障排查

### 问题1：API网关404

**原因**: Path配置不正确

**解决**:

- 确保API请求Path设置为 `/*`
- 确保后端Path也是 `/*`

### 问题2：仍然被下载

**原因**: 可能是浏览器缓存

**解决**:

1. 清除浏览器缓存
2. 使用无痕模式测试
3. 检查响应头（F12 → Network）

### 问题3：CORS错误

**原因**: 跨域配置问题

**解决**:
在API配置中启用CORS，或者在函数代码中已经处理（当前代码已处理）

---

## 📚 参考文档

- [阿里云API网关文档](https://help.aliyun.com/product/29462.html)
- [API网关对接函数计算](https://help.aliyun.com/document_detail/54788.html)

---

## ⚡ 快速总结

1. **创建API分组** → 获得网关域名
2. **创建API** → Path: `/*`, 后端选FC
3. **发布API** → RELEASE环境
4. **访问测试** → HTML正常显示！

完成以上步骤后，你的托福报名系统就可以正常访问了！🎉
